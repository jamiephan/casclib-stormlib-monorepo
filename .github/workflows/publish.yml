name: Publish Release

on:
  push:
    tags:
      - 'casclib/v*.*.*'
      - 'stormlib/v*.*.*'

jobs:
  # Detect which package to publish
  detect-package:
    name: Detect Package
    runs-on: ubuntu-latest
    outputs:
      package: ${{ steps.detect.outputs.package }}
      version: ${{ steps.detect.outputs.version }}
      tag: ${{ steps.detect.outputs.tag }}
    steps:
      - name: Detect package from tag
        id: detect
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"
          
          if [[ "$TAG" =~ ^casclib/v(.+)$ ]]; then
            echo "package=casclib" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Detected: casclib v${BASH_REMATCH[1]}"
          elif [[ "$TAG" =~ ^stormlib/v(.+)$ ]]; then
            echo "package=stormlib" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Detected: stormlib v${BASH_REMATCH[1]}"
          else
            echo "Invalid tag format"
            exit 1
          fi

  # Build native modules for all platforms
  build-native:
    name: Build on ${{ matrix.os }} (Node ${{ matrix.node }})
    needs: detect-package
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]
        node: [18, 20, 22]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev libbz2-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install zlib bzip2

      - name: Install dependencies
        run: pnpm install

      - name: Build native module
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: |
          pnpm rebuild
          pnpm build

      - name: Run tests
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: pnpm test
        env:
          CI: true

      - name: Determine platform info
        id: platform
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            echo "platform=linux" >> $GITHUB_OUTPUT
            echo "arch=x64" >> $GITHUB_OUTPUT
          elif [ "$RUNNER_OS" == "Windows" ]; then
            echo "platform=win32" >> $GITHUB_OUTPUT
            echo "arch=x64" >> $GITHUB_OUTPUT
          elif [ "$RUNNER_OS" == "macOS" ]; then
            if [[ "${{ matrix.os }}" == "macos-14" ]]; then
              echo "platform=darwin" >> $GITHUB_OUTPUT
              echo "arch=arm64" >> $GITHUB_OUTPUT
            else
              echo "platform=darwin" >> $GITHUB_OUTPUT
              echo "arch=x64" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Package native module
        shell: bash
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: |
          PACKAGE="${{ needs.detect-package.outputs.package }}"
          PLATFORM="${{ steps.platform.outputs.platform }}"
          ARCH="${{ steps.platform.outputs.arch }}"
          NODE_VERSION="${{ matrix.node }}"
          
          # Create prebuilds directory
          mkdir -p prebuilds
          
          # Copy the native module with proper naming
          if [ "$RUNNER_OS" == "Windows" ]; then
            cp "build/Release/${PACKAGE}.node" "prebuilds/${PACKAGE}-${PLATFORM}-${ARCH}-node${NODE_VERSION}.node"
          else
            cp "build/Release/${PACKAGE}.node" "prebuilds/${PACKAGE}-${PLATFORM}-${ARCH}-node${NODE_VERSION}.node"
          fi
          
          echo "Created prebuild: ${PACKAGE}-${PLATFORM}-${ARCH}-node${NODE_VERSION}.node"
          ls -lh prebuilds/

      - name: Upload prebuild artifact
        uses: actions/upload-artifact@v4
        with:
          name: prebuild-${{ needs.detect-package.outputs.package }}-${{ steps.platform.outputs.platform }}-${{ steps.platform.outputs.arch }}-node${{ matrix.node }}
          path: packages/${{ needs.detect-package.outputs.package }}/prebuilds/*.node
          retention-days: 1

  # Publish to npm and create GitHub release
  publish:
    name: Publish Package
    needs: [detect-package, build-native]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Download all prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          path: prebuilds-download
          pattern: prebuild-${{ needs.detect-package.outputs.package }}-*

      - name: Organize prebuilds
        shell: bash
        run: |
          PACKAGE="${{ needs.detect-package.outputs.package }}"
          mkdir -p "packages/${PACKAGE}/prebuilds"
          
          # Copy all prebuilds to package directory
          find prebuilds-download -name "*.node" -exec cp {} "packages/${PACKAGE}/prebuilds/" \;
          
          echo "Prebuilds collected:"
          ls -lh "packages/${PACKAGE}/prebuilds/"

      - name: Update package version
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: |
          npm version ${{ needs.detect-package.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Build TypeScript
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: pnpm build

      - name: Create tarball
        id: pack
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: |
          TARBALL=$(npm pack)
          echo "tarball=${TARBALL}" >> $GITHUB_OUTPUT
          echo "Created: ${TARBALL}"

      - name: Publish to npm
        working-directory: packages/${{ needs.detect-package.outputs.package }}
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Generate release notes
        id: release-notes
        shell: bash
        run: |
          PACKAGE="${{ needs.detect-package.outputs.package }}"
          VERSION="${{ needs.detect-package.outputs.version }}"
          
          cat > release-notes.md << 'EOF'
          # @jamiephan/$PACKAGE v$VERSION
          
          ## ðŸ“¦ Installation
          
          \`\`\`bash
          npm install @jamiephan/$PACKAGE@$VERSION
          # or
          pnpm add @jamiephan/$PACKAGE@$VERSION
          \`\`\`
          
          ## ðŸ”§ Supported Platforms
          
          This release includes prebuilt native modules for:
          
          - **Linux** (x64) - Node.js 18, 20, 22
          - **Windows** (x64) - Node.js 18, 20, 22
          - **macOS Intel** (x64) - Node.js 18, 20, 22
          - **macOS Apple Silicon** (arm64) - Node.js 18, 20, 22
          
          ## ðŸ“ Usage
          
          \`\`\`javascript
          // ES Module
          import { ${PACKAGE^} } from '@jamiephan/$PACKAGE';
          
          // CommonJS
          const { ${PACKAGE^} } = require('@jamiephan/$PACKAGE');
          \`\`\`
          
          ## ðŸš€ What's Included
          
          - Native module binaries for all supported platforms
          - Full TypeScript definitions
          - ES Module and CommonJS support
          
          ## ðŸ“š Documentation
          
          See the [README](https://github.com/${{ github.repository }}/tree/main/packages/$PACKAGE) for full documentation.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PACKAGE}/v${VERSION}
          EOF
          
          # Replace variables
          sed -i "s/\$PACKAGE/$PACKAGE/g" release-notes.md
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md
          sed -i "s/\${PACKAGE^}/${PACKAGE^}/g" release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.detect-package.outputs.tag }}
          name: '@jamiephan/${{ needs.detect-package.outputs.package }} v${{ needs.detect-package.outputs.version }}'
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            packages/${{ needs.detect-package.outputs.package }}/${{ steps.pack.outputs.tarball }}
            packages/${{ needs.detect-package.outputs.package }}/prebuilds/*.node
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on related PRs and issues
        uses: actions/github-script@v7
        with:
          script: |
            const package = '${{ needs.detect-package.outputs.package }}';
            const version = '${{ needs.detect-package.outputs.version }}';
            const tag = '${{ needs.detect-package.outputs.tag }}';
            
            const message = `ðŸŽ‰ **@jamiephan/${package} v${version}** has been published!
            
            ðŸ“¦ Install it now:
            \`\`\`bash
            npm install @jamiephan/${package}@${version}
            \`\`\`
            
            ðŸ”— [GitHub Release](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag})
            ðŸ”— [npm Package](https://www.npmjs.com/package/@jamiephan/${package}/v/${version})`;
            
            // Find recently merged PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });
            
            for (const pr of prs) {
              if (pr.merged_at) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: message
                });
              }
            }
